<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="Rabbee"><meta name=description content="å…”å­çš„å’–å•¡é¦†"><meta name=keywords content="å…”å­çš„å’–å•¡é¦†"><link rel=prev href=https://blog.rabbee.cn/2020/01/31/linux-common-commands/><link rel=canonical href=https://blog.rabbee.cn/2020/02/09/crawler-cdp/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>ä½¿ç”¨CDPçˆ¬å–ä»»æ„ç½‘ç«™ | å…”å­çš„å’–å•¡é¦†</title><meta name=title content="ä½¿ç”¨CDPçˆ¬å–ä»»æ„ç½‘ç«™ | å…”å­çš„å’–å•¡é¦†"><link rel=stylesheet href=/font/iconfont.css><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.rabbee.cn"},"articleSection":"posts","name":"ä½¿ç”¨CDPçˆ¬å–ä»»æ„ç½‘ç«™","headline":"ä½¿ç”¨CDPçˆ¬å–ä»»æ„ç½‘ç«™","description":"ç®€ä»‹ CDPå…¨ç§°Chrome DevTools Protocolï¼Œæ˜¯ä¸€ç§æ§åˆ¶å¼€å‘è€…å·¥å…·çš„åè®®ã€‚å¯ä»¥é€šè¿‡å·²å¼€æ”¾çš„åŠŸèƒ½ï¼Œæ¥é—´æ¥æ“çºµæµè§ˆå™¨å®Œæˆä¸€ç³»åˆ—è‡ªåŠ¨åŒ–å·¥ä½œã€‚\næˆ‘ä½¿ç”¨çš„å·¥å…·  chromedp æ˜¯ä¸€ä¸ªä½¿ç”¨Golangå°è£…CDPçš„é¡¹ç›®ï¼Œå®ƒçš„åŠŸèƒ½åºå¤§ï¼ŒåŒ…æ‹¬ä¸€äº›å¸¸ç”¨çš„å…ƒç´ ç‚¹å‡»ã€æ»‘åŠ¨äº‹ä»¶ç­‰ç­‰ï¼Œå¦‚æœæ˜¯åš è‡ªåŠ¨åŒ–æµ‹è¯• çš„è¯ï¼Œé€‰ç”¨å®ƒæ›´åŠ åˆé€‚ã€‚ mafredri\/cdp ä¹Ÿæ˜¯ä¸€ä¸ªä½¿ç”¨Golangå°è£…CDPçš„é¡¹ç›®ï¼Œä½†æ˜¯å®ƒä»…ä»…æ˜¯åšäº†å°è£…ï¼Œå¹¶ä¿æŒæ•´ä½“APIé£æ ¼çš„ç»Ÿä¸€ï¼Œå‡å°‘æˆ‘ä»¬ä½¿ç”¨è¿‡ç¨‹ä¸­çš„ä¸é€‚ã€‚æœ¬æ–‡å°†ä½¿ç”¨è¿™ä¸ªæ¡†æ¶è¿›è¡Œå¼€å‘ã€‚ headless-shell æ˜¯ä¸€ä¸ªåŸºäºdebiançš„æ— ç•Œé¢chromeæµè§ˆå™¨çš„dockeré•œåƒï¼Œå¯ä»¥é›†æˆåˆ°æˆ‘ä»¬å¸¸ç”¨çš„å¾®æœåŠ¡æ¶æ„é‡Œã€‚  æ­å»ºä½¿ç”¨CDPçš„æ•´ä½“æ¡†æ¶ è™½ç„¶mafredri\/cdpæä¾›äº†æœ€åŸºç¡€çš„ä½¿ç”¨æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦åœ¨å®ƒçš„åŸºç¡€ä¸Šä¿®æ”¹ï¼Œä»¥ä¾¿èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå’ŒæŒç»­ç¨³å®šçˆ¬å–çš„è¦æ±‚ã€‚\nåˆå§‹åŒ–ä¸å¼€å‘è€…å·¥å…·çš„è¿œç¨‹è¿æ¥ var ( cdpHost = \x26#34;127.0.0.1\x26#34; cdpPort = \x26#34;9222\x26#34; devt *devtool.DevTools ) func init() { devt = devtool.New(fmt.Sprintf(\x26#34;http:\/\/%s:%d\x26#34;, cdpHost, cdpPort)) } é€šè¿‡è®¿é—®é¡µé¢æ¥è·å–æ‰€æœ‰è¯·æ±‚è¿”å›çš„æ•°æ® func Run(url string) { ctx, cancel := context.WithTimeout(context.Background(), timeout) \/\/è¯¥é¡µé¢çš„è¶…æ—¶æ—¶é—´ï¼Œæœ€å¥½å¢åŠ å¤šä¸€äº›ç¼“å†²æ—¶é—´ï¼Œä¸ç„¶é¡µé¢çº¿ç¨‹å¯èƒ½æ¯”è·å–æ•°æ®çš„çº¿ç¨‹æ—©é€€å‡º  defer cancel() \/\/æ‰“å¼€ä¸€ä¸ªç©ºç™½é¡µ  pt, err := devt.Create(ctx) if err != nil { return } defer devt.Close(ctx, pt) \/\/é€€å‡ºæ—¶å…³é—­  conn, err := rpcc.","inLanguage":"zh-cn","author":"Rabbee","creator":"Rabbee","publisher":"Rabbee","accountablePerson":"Rabbee","copyrightHolder":"Rabbee","copyrightYear":"2020","datePublished":"2020-02-09 13:52:09 \x2b0800 CST","dateModified":"2020-02-09 13:52:09 \x2b0800 CST","url":"https:\/\/blog.rabbee.cn\/2020\/02\/09\/crawler-cdp\/","wordCount":"433","keywords":["crawler","chromedp","cdp","headless-shell","docker","golang","å…”å­çš„å’–å•¡é¦†"]}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://blog.rabbee.cn>å…”å­çš„å’–å•¡é¦†</a></div><div class="menu navbar-right"><a class=menu-item href=/posts/>æ–‡ç« </a>
<a class=menu-item href=/categories/>ç›®å½•</a>
<a class=menu-item href=/tags/>æ ‡ç­¾</a>
<a class=menu-item href=/about/>å…³äº</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://blog.rabbee.cn>å…”å­çš„å’–å•¡é¦†</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=/posts/>æ–‡ç« </a>
<a class=menu-item href=/categories/>ç›®å½•</a>
<a class=menu-item href=/tags/>æ ‡ç­¾</a>
<a class=menu-item href=/about/>å…³äº</a></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">ä½¿ç”¨CDPçˆ¬å–ä»»æ„ç½‘ç«™</h1><div class=post-meta>Written by <a itemprop=name href=https://blog.rabbee.cn rel=author>Rabbee</a> with â™¥
<span class=post-time>on <time datetime=2020-02-09 itemprop=datePublished>February 9, 2020</time></span>
in
<i class="iconfont icon-folder"></i><span class=post-category><a href=https://blog.rabbee.cn/categories/%E7%88%AC%E8%99%AB/>çˆ¬è™«</a></span></div></header><div class=post-content><h2 id=ç®€ä»‹>ç®€ä»‹</h2><p>CDPå…¨ç§°<a href=https://chromedevtools.github.io/devtools-protocol/><code>Chrome DevTools Protocol</code></a>ï¼Œæ˜¯ä¸€ç§æ§åˆ¶å¼€å‘è€…å·¥å…·çš„åè®®ã€‚å¯ä»¥é€šè¿‡å·²å¼€æ”¾çš„åŠŸèƒ½ï¼Œæ¥é—´æ¥æ“çºµæµè§ˆå™¨å®Œæˆä¸€ç³»åˆ—è‡ªåŠ¨åŒ–å·¥ä½œã€‚</p><h2 id=æˆ‘ä½¿ç”¨çš„å·¥å…·>æˆ‘ä½¿ç”¨çš„å·¥å…·</h2><ul><li><a href=https://chromedevtools.github.io/devtools-protocol/><code>chromedp</code></a>
æ˜¯ä¸€ä¸ªä½¿ç”¨Golangå°è£…CDPçš„é¡¹ç›®ï¼Œå®ƒçš„åŠŸèƒ½åºå¤§ï¼ŒåŒ…æ‹¬ä¸€äº›å¸¸ç”¨çš„<a href=https://github.com/chromedp/examples/blob/master/click/main.go>å…ƒç´ ç‚¹å‡»ã€æ»‘åŠ¨äº‹ä»¶</a>ç­‰ç­‰ï¼Œå¦‚æœæ˜¯åš è‡ªåŠ¨åŒ–æµ‹è¯• çš„è¯ï¼Œé€‰ç”¨å®ƒæ›´åŠ åˆé€‚ã€‚</li><li><a href=https://github.com/mafredri/cdp><code>mafredri/cdp</code></a>
ä¹Ÿæ˜¯ä¸€ä¸ªä½¿ç”¨Golangå°è£…CDPçš„é¡¹ç›®ï¼Œä½†æ˜¯å®ƒä»…ä»…æ˜¯åšäº†å°è£…ï¼Œå¹¶ä¿æŒæ•´ä½“APIé£æ ¼çš„ç»Ÿä¸€ï¼Œå‡å°‘æˆ‘ä»¬ä½¿ç”¨è¿‡ç¨‹ä¸­çš„ä¸é€‚ã€‚æœ¬æ–‡å°†ä½¿ç”¨è¿™ä¸ªæ¡†æ¶è¿›è¡Œå¼€å‘ã€‚</li><li><a href=https://hub.docker.com/r/chromedp/headless-shell/><code>headless-shell</code></a>
æ˜¯ä¸€ä¸ªåŸºäºdebiançš„æ— ç•Œé¢chromeæµè§ˆå™¨çš„dockeré•œåƒï¼Œå¯ä»¥é›†æˆåˆ°æˆ‘ä»¬å¸¸ç”¨çš„å¾®æœåŠ¡æ¶æ„é‡Œã€‚</li></ul><h2 id=æ­å»ºä½¿ç”¨cdpçš„æ•´ä½“æ¡†æ¶>æ­å»ºä½¿ç”¨CDPçš„æ•´ä½“æ¡†æ¶</h2><p>è™½ç„¶<code>mafredri/cdp</code>æä¾›äº†æœ€åŸºç¡€çš„ä½¿ç”¨æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦åœ¨å®ƒçš„åŸºç¡€ä¸Šä¿®æ”¹ï¼Œä»¥ä¾¿èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå’ŒæŒç»­ç¨³å®šçˆ¬å–çš„è¦æ±‚ã€‚</p><h3 id=åˆå§‹åŒ–ä¸å¼€å‘è€…å·¥å…·çš„è¿œç¨‹è¿æ¥>åˆå§‹åŒ–ä¸å¼€å‘è€…å·¥å…·çš„è¿œç¨‹è¿æ¥</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>var</span> (
  <span style=color:#a6e22e>cdpHost</span> = <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
  <span style=color:#a6e22e>cdpPort</span> = <span style=color:#e6db74>&#34;9222&#34;</span>
  <span style=color:#a6e22e>devt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>devtool</span>.<span style=color:#a6e22e>DevTools</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
  <span style=color:#a6e22e>devt</span> = <span style=color:#a6e22e>devtool</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;http://%s:%d&#34;</span>, <span style=color:#a6e22e>cdpHost</span>, <span style=color:#a6e22e>cdpPort</span>))
}
</code></pre></div><h3 id=é€šè¿‡è®¿é—®é¡µé¢æ¥è·å–æ‰€æœ‰è¯·æ±‚è¿”å›çš„æ•°æ®>é€šè¿‡è®¿é—®é¡µé¢æ¥è·å–æ‰€æœ‰è¯·æ±‚è¿”å›çš„æ•°æ®</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>url</span> <span style=color:#66d9ef>string</span>) {
  <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>timeout</span>) <span style=color:#75715e>//è¯¥é¡µé¢çš„è¶…æ—¶æ—¶é—´ï¼Œæœ€å¥½å¢åŠ å¤šä¸€äº›ç¼“å†²æ—¶é—´ï¼Œä¸ç„¶é¡µé¢çº¿ç¨‹å¯èƒ½æ¯”è·å–æ•°æ®çš„çº¿ç¨‹æ—©é€€å‡º
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()

  <span style=color:#75715e>//æ‰“å¼€ä¸€ä¸ªç©ºç™½é¡µ
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>pt</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>devt</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#a6e22e>ctx</span>)
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#66d9ef>return</span>
  }
  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>devt</span>.<span style=color:#a6e22e>Close</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pt</span>) <span style=color:#75715e>//é€€å‡ºæ—¶å…³é—­
</span><span style=color:#75715e></span>
  <span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rpcc</span>.<span style=color:#a6e22e>DialContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pt</span>.<span style=color:#a6e22e>WebSocketDebuggerURL</span>)
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#66d9ef>return</span>
  }
  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()

  <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cdp</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>conn</span>)

  <span style=color:#75715e>// è¯¥æ³¨é‡Šéƒ¨åˆ†æ˜¯æ¨¡æ‹ŸæŸç§è®¾å¤‡
</span><span style=color:#75715e></span>  <span style=color:#75715e>// err = c.Emulation.ClearDeviceMetricsOverride(ctx)
</span><span style=color:#75715e></span>  <span style=color:#75715e>// if err != nil {
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 	return
</span><span style=color:#75715e></span>  <span style=color:#75715e>// }
</span><span style=color:#75715e></span>
  <span style=color:#75715e>// err = c.Emulation.SetDeviceMetricsOverride(ctx,
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 	&amp;emulation.SetDeviceMetricsOverrideArgs{
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 		Width:						 config.Device.WindowWidth,
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 		Height:						config.Device.WindowHeight,
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 		DeviceScaleFactor: 1,
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 		Mobile:						config.Device.Mobile})
</span><span style=color:#75715e></span>  <span style=color:#75715e>// if err != nil {
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 	return
</span><span style=color:#75715e></span>  <span style=color:#75715e>// }
</span><span style=color:#75715e></span>
  <span style=color:#a6e22e>domContent</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Page</span>.<span style=color:#a6e22e>DOMContentEventFired</span>(<span style=color:#a6e22e>ctx</span>)
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#66d9ef>return</span>
  }
  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>domContent</span>.<span style=color:#a6e22e>Close</span>()

  <span style=color:#75715e>// æ‰¹é‡å¤„ç†é”™è¯¯
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>runBatch</span>(
    <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>DOM</span>.<span style=color:#a6e22e>Enable</span>(<span style=color:#a6e22e>ctx</span>) },
    <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Network</span>.<span style=color:#a6e22e>Enable</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#66d9ef>nil</span>) },
    <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Page</span>.<span style=color:#a6e22e>Enable</span>(<span style=color:#a6e22e>ctx</span>) },
  ); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#66d9ef>return</span>
  }

  <span style=color:#75715e>// ç›‘å¬æ¯ä¸ªè¯·æ±‚æ”¶åˆ°çš„æ•°æ®
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
    <span style=color:#a6e22e>responseReceived</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Network</span>.<span style=color:#a6e22e>ResponseReceived</span>(<span style=color:#a6e22e>ctx</span>)
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span>
    }
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>responseReceived</span>.<span style=color:#a6e22e>Close</span>()
    <span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>timeout</span>)
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>Stop</span>()
    <span style=color:#66d9ef>for</span> {
      <span style=color:#66d9ef>select</span> {
      <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span>:
        <span style=color:#66d9ef>return</span>
      <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
        <span style=color:#66d9ef>return</span>
      <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>responseReceived</span>.<span style=color:#a6e22e>Ready</span>(): <span style=color:#75715e>//æ¯ä¸ªè¯·æ±‚è·å¾—çš„æ•°æ®
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>ev</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>responseReceived</span>.<span style=color:#a6e22e>Recv</span>()
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
          <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)
          <span style=color:#66d9ef>break</span>
        }
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bodyReply</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Network</span>.<span style=color:#a6e22e>GetResponseBody</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>GetResponseBodyArgs</span>{<span style=color:#a6e22e>RequestID</span>: <span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>RequestID</span>}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
          <span style=color:#75715e>//å¼‚æ­¥æ‰§è¡Œå›è°ƒä»»åŠ¡
</span><span style=color:#75715e></span>          <span style=color:#75715e>// go func() {
</span><span style=color:#75715e></span>          <span style=color:#75715e>// 	callback(ev, bodyReply.Body)
</span><span style=color:#75715e></span>          <span style=color:#75715e>// }()
</span><span style=color:#75715e></span>        }
      }
    }
  }()
  <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Page</span>.<span style=color:#a6e22e>Navigate</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>NewNavigateArgs</span>(<span style=color:#a6e22e>url</span>))
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#66d9ef>return</span>
  }
  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>timeout</span>)
  <span style=color:#75715e>// æ­¤å¤„ååŠ å…¥ä½ éœ€è¦è¿›è¡Œçš„æ“ä½œï¼Œä¸€ä¸ªç½‘ç«™åŠ è½½æ‰€æœ‰è¯·æ±‚ï¼Œå’Œæ¸²æŸ“é¡µé¢éƒ½éœ€è¦æ—¶é—´ï¼Œ	è¶…æ—¶æ—¶é—´éœ€è¦é…Œæƒ…è®¾ç½®ã€‚
</span><span style=color:#75715e></span>  <span style=color:#75715e>// æ¯”å¦‚ç‚¹å‡»äº‹ä»¶å•¥çš„ç©æ„
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>runBatchFunc</span> <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>runBatch</span>(<span style=color:#a6e22e>fn</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>runBatchFunc</span>) <span style=color:#66d9ef>error</span> {
  <span style=color:#a6e22e>eg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errgroup</span>.<span style=color:#a6e22e>Group</span>{}
  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>fn</span> {
    <span style=color:#a6e22e>eg</span>.<span style=color:#a6e22e>Go</span>(<span style=color:#a6e22e>f</span>)
  }
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>eg</span>.<span style=color:#a6e22e>Wait</span>()
}
</code></pre></div><blockquote><p>å…¶å®å‰é¢çš„æ“ä½œå·²ç»å¯ä»¥è·å–åˆ°é¡µé¢ä¸­æ‰€æœ‰è¯·æ±‚è¿”å›çš„æ•°æ®äº†,å‰©ä¸‹çš„å°±æ˜¯æ ¹æ®æ¥å£æ•°æ®çš„ç‰¹å¾æ¥æå–æƒ³è¦çš„æ•°æ®ã€‚</p></blockquote><h3 id=å°è£…ç‚¹å‡»äº‹ä»¶>å°è£…ç‚¹å‡»äº‹ä»¶</h3><p>å…¶å®å¦‚æœè¦æ›´å¤šåŠŸèƒ½ï¼Œç›´æ¥ç”¨<code>chromedp</code>å¯èƒ½æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚ä½†æ˜¯æˆ‘ä»¬å¦‚æœä½¿ç”¨äº†<code>mafredri/cdp</code>ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å‚è€ƒ<code>chromedp</code>çš„å®ç°æ–¹å¼æ¥å°è£…ä¸€äº›å¸¸ç”¨åŠŸèƒ½ã€‚</p><h4 id=ç‚¹å‡»æŸä¸ªç‚¹>ç‚¹å‡»æŸä¸ªç‚¹</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Click</span>(<span style=color:#a6e22e>clt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cdp</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>float64</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
  <span style=color:#a6e22e>ts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>TouchPoint</span>{<span style=color:#a6e22e>X</span>: <span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>Y</span>: <span style=color:#a6e22e>y</span>}
  <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>clt</span>.<span style=color:#a6e22e>Input</span>.<span style=color:#a6e22e>DispatchTouchEvent</span>(<span style=color:#a6e22e>clt</span>.<span style=color:#a6e22e>Ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>DispatchTouchEventArgs</span>{
    <span style=color:#a6e22e>Type</span>:        <span style=color:#e6db74>&#34;touchStart&#34;</span>,
    <span style=color:#a6e22e>TouchPoints</span>: []<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>TouchPoint</span>{<span style=color:#a6e22e>ts</span>},
  })
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#66d9ef>return</span>
  }
  <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>clt</span>.<span style=color:#a6e22e>Input</span>.<span style=color:#a6e22e>DispatchTouchEvent</span>(<span style=color:#a6e22e>clt</span>.<span style=color:#a6e22e>Ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>DispatchTouchEventArgs</span>{
    <span style=color:#a6e22e>Type</span>:        <span style=color:#e6db74>&#34;touchEnd&#34;</span>,
    <span style=color:#a6e22e>TouchPoints</span>: []<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>TouchPoint</span>{},
  })
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#66d9ef>return</span>
  }
  <span style=color:#66d9ef>return</span>
}
</code></pre></div><h4 id=ç‚¹å‡»æŸä¸ªå…ƒç´ >ç‚¹å‡»æŸä¸ªå…ƒç´ </h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ClickElement</span>(<span style=color:#a6e22e>clt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cdp</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>el</span>, <span style=color:#a6e22e>text</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
  <span style=color:#a6e22e>expression</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>
</span><span style=color:#e6db74>function contains(selector, text) </span><span style=color:#e6db74>{</span><span style=color:#e6db74>
</span><span style=color:#e6db74>  var elements = document.querySelectorAll(selector);
</span><span style=color:#e6db74>  return Array.prototype.filter.call(elements, function(element)</span><span style=color:#e6db74>{</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    return RegExp(text).test(element.textContent);
</span><span style=color:#e6db74>  });
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74>contains(&#39;%s&#39;, &#39;%s&#39;).forEach((value, index, array) =&gt; </span><span style=color:#e6db74>{</span><span style=color:#e6db74>
</span><span style=color:#e6db74>  value.click();
</span><span style=color:#e6db74>});
</span><span style=color:#e6db74></span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>el</span>, <span style=color:#a6e22e>text</span>)
  <span style=color:#a6e22e>evalArgs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>NewEvaluateArgs</span>(<span style=color:#a6e22e>expression</span>)
  <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>clt</span>.<span style=color:#a6e22e>Runtime</span>.<span style=color:#a6e22e>Evaluate</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Ctx</span>, <span style=color:#a6e22e>evalArgs</span>)
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#66d9ef>return</span>
  }
  <span style=color:#66d9ef>return</span>
}
</code></pre></div><h3 id=é¢å¤–çš„è¯>é¢å¤–çš„è¯</h3><p>å¦‚æœè¦æ­å»ºå¥½æ•´ä¸ªåŸºäºcdpçš„çˆ¬è™«ï¼Œå½“ç„¶è¦åšå¾ˆå¤šå°è£…çš„å·¥ä½œã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥å°è£…ä¸€å°IPhone6 ğŸ˜</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Device</span> <span style=color:#66d9ef>struct</span> {
  <span style=color:#a6e22e>WindowWidth</span>  <span style=color:#66d9ef>int</span>
  <span style=color:#a6e22e>WindowHeight</span> <span style=color:#66d9ef>int</span>
  <span style=color:#a6e22e>Mobile</span>       <span style=color:#66d9ef>bool</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>IPhone6</span>() <span style=color:#a6e22e>Device</span> {
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Device</span>{
    <span style=color:#a6e22e>WindowWidth</span>:  <span style=color:#ae81ff>375</span>,
    <span style=color:#a6e22e>WindowHeight</span>: <span style=color:#ae81ff>667</span>,
    <span style=color:#a6e22e>Mobile</span>:       <span style=color:#66d9ef>true</span>,
  }
}
</code></pre></div><h4 id=å¯åŠ¨ä¸€ä¸ªçˆ¬è™«ä»»åŠ¡>å¯åŠ¨ä¸€ä¸ªçˆ¬è™«ä»»åŠ¡</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
  <span style=color:#a6e22e>NewCrawler</span>(
    <span style=color:#a6e22e>NewDriver</span>(<span style=color:#a6e22e>Config</span>{<span style=color:#a6e22e>Timeout</span>: <span style=color:#a6e22e>timeout</span>, <span style=color:#a6e22e>Device</span>: <span style=color:#a6e22e>IPhone6</span>()}),
  ).<span style=color:#a6e22e>Run</span>()
}
</code></pre></div></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Rabbee</span></p><p class=copyright-item><span>Link:</span>
<a href=https://blog.rabbee.cn/2020/02/09/crawler-cdp/>https://blog.rabbee.cn/2020/02/09/crawler-cdp/</span></p><p class="copyright-item lincese">æœ¬æ–‡é‡‡ç”¨<a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨ 4.0 å›½é™…è®¸å¯åè®®</a>è¿›è¡Œè®¸å¯</p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://blog.rabbee.cn/tags/crawler/>#crawler</a></span>
<span class=tag><a href=https://blog.rabbee.cn/tags/chromedp/>#chromedp</a></span>
<span class=tag><a href=https://blog.rabbee.cn/tags/cdp/>#cdp</a></span>
<span class=tag><a href=https://blog.rabbee.cn/tags/headless-shell/>#headless-shell</a></span>
<span class=tag><a href=https://blog.rabbee.cn/tags/docker/>#docker</a></span>
<span class=tag><a href=https://blog.rabbee.cn/tags/golang/>#golang</a></span></section><section><a href=javascript:window.history.back();>back</a></span> Â·
<span><a href=https://blog.rabbee.cn>home</a></span></section></div><div class=post-nav><a href=https://blog.rabbee.cn/2020/01/31/linux-common-commands/ class=prev rel=prev title=Linuxå¸¸ç”¨å‘½ä»¤><i class="iconfont icon-left"></i>&nbsp;Linuxå¸¸ç”¨å‘½ä»¤</a></div><div class=post-comment><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"crabbit"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><p class=copyright><span itemprop=copyrightYear><a href=https://blog.rabbee.cn target=_blank rel="external nofollow">Copyright &copy; 2017 - 2020</a></span>
<span class=with-love><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-love"></i></a></span><span class=author itemprop=copyrightHolder><a href=/about>Rabbee</a></span></p><p><a href=http://www.beian.miit.gov.cn/ target=_blank rel="external nofollow">ç²¤ICPå¤‡20004985å·</a> |
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/liuzc/leaveit target=_blank rel="external nofollow">LeaveIt</a></span></p></footer><script src=/js/vendor_no_gallery.min.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-157514920-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?3e00c4d00e34ee96078ee6798917c6f3";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script></div></body></html>